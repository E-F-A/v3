# +---------------------------------------------------+
# Function to enable/disable per user spam scoring
# +---------------------------------------------------+
func_peruser(){
  func_echo-header
  echo -e "$green[EFA]$clean Enable/Disable per user spam scoring"
  echo -e ""
  echo -e "$green[EFA]$clean By default this feature is off." 
  echo -e "$green[EFA]$clean Per user spam scores allow you to specify differing scores based"
  echo -e "$green[EFA]$clean on user in the MailWatch GUI."
  echo ""
  echo -e "$green[EFA]$clean Caution: users that do not have an account in MailWatch will not"
  echo -e "$green[EFA]$clean be scanned! This is a current limitation in MailWatch per user"
  echo -e "$green[EFA]$clean handling of spam scores."
  echo ""
  if [[ $(grep "Required SpamAssassin Score" /etc/MailScanner/MailScanner.conf | awk -F'=' {'print $2'} | tr -d ' ') == "&SQLSpamScores" ]]
    then
      echo -e "$green[EFA]$clean Per user scoring is $green ENABLED $clean"
      echo -e -n "$green[EFA]$clean Would you like to $red DISABLE $clean per user scoring? [y/N/c]: "
      read TMPUSER
      FLAG=1
      while [ $FLAG != "0" ]
        do
          if [[ "$TMPUSER" == "Y" || "$TMPUSER" == "y" ]]; then
            echo -e -n "$green[EFA]$clean Please enter your new global Spam Score [1-100, default 4]: "
            read SPAMSCORE
            FLAG2 = 1
            while [ $FLAG2 != "0" ]; do
              if [[ "$SPAMSCORE" =~ ^[1-9]|[1-9][0-9]|100$ ]]; then
                sed -i "/^Required SpamAssassin Score =/ c\Required SpamAssassin Score = $SPAMSCORE" /etc/MailScanner/MailScanner.conf
                FLAG2=0
              elif [[ -z "$SPAMSCORE" ]]; then
                sed -i "/^Required SpamAssassin Score =/ c\Required SpamAssassin Score = 4" /etc/MailScanner/MailScanner.conf
                FLAG2=0
              else
                echo -e "       $red ERROR: Invalid entry.$clean"
                echo -e -n "$green[EFA]$clean Please enter your new global Spam Score [1-100, default 4]: "
                read SPAMSCORE
              fi
            done

            echo -e -n "$green[EFA]$clean Please enter your new global High Spam Score [1-100, default 7]: "
            read HIGHSPAMSCORE
            FLAG3 = 1
            while [ $FLAG3 != "0" ]; do
              if [[ "$HIGHSPAMSCORE" =~ ^[1-9]|[1-9][0-9]|100$ ]]; then
                sed -i "/^High SpamAssassin Score =/ c\High SpamAssassin Score = $SPAMSCORE" /etc/MailScanner/MailScanner.conf
                FLAG3=0
              elif [[ -z "$SPAMSCORE" ]]; then
                sed -i "/^High SpamAssassin Score =/ c\High SpamAssassin Score = 7" /etc/MailScanner/MailScanner.conf
                FLAG3=0
              else
                echo -e "       $red ERROR: Invalid entry.$clean"
                echo -e -n "$green[EFA]$clean Please enter your new global High Spam Score [1-100, default 7]: "
                read HIGHSPAMSCORE
              fi
            done

          service MailScanner restart
          FLAG=1
          echo -e "$green[EFA]$clean Per user spam scoring $red DISABLED $clean"
          pause
        elif [[ "$TMPUSER" == "n" | "$TMPUSER" == "N" | -z "$TMPUSER" ]]; then 
          echo -e "$green[EFA]$clean No changes made"
          echo ""
          FLAG=1
          pause
        elif [[ "$TMPUSER == "C" | "$TMPUSER == "c" ]]; then
          echo "$green[EFA]$clean No changes made"
          FLAG=1
          pause
        else
          echo -e "       $red ERROR: please make an selection.$clean"
          echo -e -n "$green[EFA]$clean Would you like to $red DISABLE $clean per user scoring? [y/N/c]: "
          read TMPUSER
        fi
      done
    else
      echo -e "$green[EFA]$clean Per user scoring is $red DISABLED $clean"
      echo -e -n "$green[EFA]$clean Would you like to $green ENABLE $clean per user scoring? [y/N/c]: "
      read TMPUSER
      FLAG=1
      while [ $FLAG != "0" ]
        do
          if [[ "$TMPUSER" == "Y" || "$TMPUSER" == "y" ]]; then
            echo -e -n "$green[EFA]$clean Please enter your new default per user Spam Score [1-100, default 4]: "
            read SPAMSCORE
            FLAG2 = 1
            while [ $FLAG2 != "0" ]; do
              if [[ "$SPAMSCORE" =~ ^[1-9]|[1-9][0-9]|100$ ]]; then
                MAILWATCHPW=`grep MAILWATCHSQLPWD /etc/EFA-Config | awk -F':' '{print $2}'`
                /usr/bin/mysql -u mailwatch -p"$MAILWATCHPW" mailscanner -e "ALTER TABLE `user` MODIFY COLUMN `spamscore` NOT NULL DEFAULT '$SPAMSCORE';"
                MAILWATCHPW=''
                sed -i "/^Required SpamAssassin Score =/ c\Required SpamAssassin Score = &SQLSpamScores" /etc/MailScanner/MailScanner.conf
                FLAG2=0
              elif [[ -z "$SPAMSCORE" ]]; then
                MAILWATCHPW=`grep MAILWATCHSQLPWD /etc/EFA-Config | awk -F':' '{print $2}'`
                /usr/bin/mysql -u mailwatch -p"$MAILWATCHPW" mailscanner -e "ALTER TABLE `user` MODIFY COLUMN `spamscore` NOT NULL DEFAULT '4';"
                MAILWATCHPW=''
                sed -i "/^Required SpamAssassin Score =/ c\Required SpamAssassin Score = &SQLSpamScores" /etc/MailScanner/MailScanner.conf
                FLAG2=0
              else
                echo -e "       $red ERROR: Invalid entry.$clean"
                echo -e -n "$green[EFA]$clean Please enter your new default per user Spam Score [1-100, default 4]: "
                read SPAMSCORE
              fi
            done

            echo -e -n "$green[EFA]$clean Please enter your new per user High Spam Score [1-100, default 7]: "
            read HIGHSPAMSCORE
            FLAG3 = 1
            while [ $FLAG3 != "0" ]; do
              if [[ "$HIGHSPAMSCORE" =~ ^[1-9]|[1-9][0-9]|100$ ]]; then
                MAILWATCHPW=`grep MAILWATCHSQLPWD /etc/EFA-Config | awk -F':' '{print $2}'`
                /usr/bin/mysql -u mailwatch -p"$MAILWATCHPW" mailscanner -e "ALTER TABLE `user` MODIFY COLUMN `highspamscore` NOT NULL DEFAULT '$HIGHSPAMSCORE';"
                MAILWATCHPW=''
                sed -i "/^High SpamAssassin Score =/ c\High SpamAssassin Score = &SQLHighSpamScores" /etc/MailScanner/MailScanner.conf
                FLAG3=0
              elif [[ -z "$SPAMSCORE" ]]; then
                MAILWATCHPW=`grep MAILWATCHSQLPWD /etc/EFA-Config | awk -F':' '{print $2}'`
                /usr/bin/mysql -u mailwatch -p"$MAILWATCHPW" mailscanner -e "ALTER TABLE `user` MODIFY COLUMN `highspamscore` NOT NULL DEFAULT '7';"
                MAILWATCHPW=''
                sed -i "/^High SpamAssassin Score =/ c\High SpamAssassin Score = &SQLHighSpamScores" /etc/MailScanner/MailScanner.conf
                FLAG3=0
              else
                echo -e "       $red ERROR: Invalid entry.$clean"
                echo -e -n "$green[EFA]$clean Please enter your new global High Spam Score [1-100, default 7]: "
                read HIGHSPAMSCORE
              fi
            done

          service MailScanner restart
          FLAG=1
          echo -e "$green[EFA]$clean Per user spam scoring $green ENABLED $clean"
          pause
        elif [[ "$TMPUSER" == "n" | "$TMPUSER" == "N" | -z "$TMPUSER" ]]; then 
          echo -e "$green[EFA]$clean No changes made"
          echo ""
          FLAG=1
          pause
        elif [[ "$TMPUSER == "C" | "$TMPUSER == "c" ]]; then
          echo "$green[EFA]$clean No changes made"
          FLAG=1
          pause
        else
          echo -e "       $red ERROR: please make an selection.$clean"
          echo -e -n "$green[EFA]$clean Would you like to $green ENABLE $clean per user scoring? [y/N/c]: "
          read TMPUSER
        fi
      done
     
}
# +---------------------------------------------------+