#!/bin/bash
# +--------------------------------------------------------------------+
# EFA update script
# Version 20150426
# +--------------------------------------------------------------------+
# Copyright (C) 2012~2015 http://www.efa-project.org
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
# +--------------------------------------------------------------------+

#----------------------------------------------------------------#
# Variables
#----------------------------------------------------------------#
VERSION="3.0.0.8"
logdir="/var/log/EFA"
yumexclude="kernel* mysql* postfix* mailscanner* clamav* clamd*"
ADMINEMAIL="`cat /etc/EFA-Config | grep ADMINEMAIL | sed 's/.*://'`"
MAILFROM="$ADMINEMAIL"
MAILTO="$ADMINEMAIL"
MAILSUBJECT="EFA Update Complete For: `hostname`"
SENDMAIL="/usr/lib/sendmail"
TMPMAIL="/tmp/tempmail"
STAGING="/tmp/EFA-Staging"
#----------------------------------------------------------------#

#----------------------------------------------------------------#
# List of current version numbers for the software we use
#----------------------------------------------------------------#
MAILWATCHVERSION="7f6858df83"
IMAGECEBERUSVERSION="1.1"
SPAMASSASSINVERSION="3.4.0"
PYZORVERSION="0.7.0"
VMTOOLSVERSION="9.4.0-1280544"
WEBMINVERSION="1.690-1"
#----------------------------------------------------------------#

#----------------------------------------------------------------#
# Function where we do all our magic
#----------------------------------------------------------------#
function run_update() {
  echo "Starting update to E.F.A. 3.0.0.8"

  # To package for this update:
  # /EFA-Version-Upgrade                  <- This file in the root, renamed!
  # /Files/										            <- Directory (containing binary files)
  # /Files/geoip-5fc9611.tar.gz           <- GeoIP update files
  # /Scripts/									            <- Directory (containing update scripts (previous git scripts))
  # /Scripts/lib-EFA-Configure            <- Complete EFA-Configure dir with all files
  # /Scripts/EFA-Configure                <- EFA-Configure script

  ##### Backup Phase #####
  /usr/local/sbin/EFA-Backup -backup

  ##### Commit Phase #####

  # grab latest version of EFA-Configure with libraries
  rm -f /usr/local/sbin/EFA-Configure
  rm -f /var/EFA/lib/EFA-Configure/*
  mv $STAGING/Scripts/EFA-Configure /usr/local/sbin/EFA-Configure
  mkdir -p /var/EFA/lib/EFA-Configure
  mv $STAGING/Scripts/lib-EFA-Configure/* /var/EFA/lib/EFA-Configure/
  chmod 700 /usr/local/sbin/EFA-Configure
  chmod 600 /var/EFA/lib/EFA-Configure/*

  # Issue #132 Increase sa-learn and spamassassin message size limits
  # Do not alter if not at default level
  TEST=$(grep '^Max Spam Check Size = 200k' /etc/MailScanner/MailScanner.conf)
  if [[ -n $TEST ]]; then
    sed -i "/^Max Spam Check Size =/ c\Max Spam Check Size = 2048k" /etc/MailScanner/MailScanner.conf
  fi

  # Issue #157 Razor failing after registration of service
  # Reapply perms for new builds
  # Setgid
  chown -R postfix:apache /var/spool/postfix/.razor
  chmod g+s /var/spool/postfix/.razor
  chmod ug+rwx /var/spool/postfix/.razor
  chmod ug+rw /var/spool/postfix/.razor

  # Issue #156 -- GeoIP Bug
  mv $STAGING/Files/geoip-5fc9611.tar.gz /usr/src/EFA
  tar xzvf /usr/src/EFA/geoip-5fc9611.tar.gz
  cd /usr/src/EFA/geoip-api-perl
  perl Makefile.PL
  make
  make install
  cd ~
  rm -rf /usr/src/EFA/geoip*

  # Issue #166 MailWatch cron job not executing contents
  sed -i "/^#!/bin/sh$/ c\#!/bin/bash" /etc/cron.daily/mailwatch

  # Issue #45 Add ScamNailer Ruleset
  # todo:  Host this on dl.efa-project.org
  echo -e "#EFA: ScamNailer ClamAV Ruleset\nDatabaseCustomURL http://www.mailscanner.eu/scamnailer.ndb" >> /etc/freshclam.conf

  # Issue #169 Clean up clamav-unoffical-sigs script
  sed -i '/^mbl_dbs="/ c\#mbl_dbs="' /usr/local/etc/clamav-unofficial-sigs.conf
  sed -i '/^#mbl_dbs="/ {n; s/.*/#  mbl.ndb/}' /usr/local/etc/clamav-unofficial-sigs.conf
  sed -i '/^#mbl_dbs="/ {n;n; s/.*/#"/}' /usr/local/etc/clamav-unofficial-sigs.conf

  echo "$VERSION update is complete"
  echo ""
  echo "" >> $TMPMAIL
  echo "Update to $VERSION complete." >> $TMPMAIL
}
#----------------------------------------------------------------#

#----------------------------------------------------------------#
# Function to update system with yum
#----------------------------------------------------------------#
function yum_update() {
  yum -y --exclude="$yumexclude" update
  # Todo, write some logic that checks any of the yumexclude packages and updates them after testing...
}
#----------------------------------------------------------------#

#----------------------------------------------------------------#
# Finalize
#----------------------------------------------------------------#
function finalize() {
  # Write the latest version number
  echo "EFA-$VERSION" > /etc/EFA-Version
  sed -i "/--- Welcome to EFA-/ c\--- Welcome to EFA-$VERSION ---" /etc/issue

  # Finalize the mail
  echo "" >> $TMPMAIL
  echo "Please visit http://www.efa-project.org for more information." >> $TMPMAIL
}
#----------------------------------------------------------------#

#----------------------------------------------------------------#
# Where to start
#----------------------------------------------------------------#
initialize
run_update
finalize
